{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "RAG Chat Response with Search Boosting Metadata",
  "description": "Extended response payload from RAG backend with selected_text search boosting information",
  "type": "object",
  "required": ["answer", "sources", "confidence", "metadata"],
  "properties": {
    "answer": {
      "type": "string",
      "description": "LLM-generated answer with optional citations",
      "minLength": 1,
      "examples": ["Forward kinematics is the process of determining the position and orientation of the end-effector given joint angles. See Chapter 3, Section 3.2 for details."]
    },
    "sources": {
      "type": "array",
      "description": "Retrieved source chunks from vector database",
      "minItems": 0,
      "maxItems": 10,
      "items": {
        "type": "object",
        "required": ["id", "title", "snippet", "url", "similarity"],
        "properties": {
          "id": {
            "type": "string",
            "description": "Unique chunk ID from vector database",
            "examples": ["chunk-3-2-1", "chapter-3-section-2-para-1"]
          },
          "title": {
            "type": "string",
            "description": "Source title (chapter and section)",
            "examples": ["Chapter 3, Section 3.2 - Forward Kinematics"]
          },
          "snippet": {
            "type": "string",
            "description": "Relevant text excerpt (200-400 characters)",
            "minLength": 10,
            "maxLength": 500
          },
          "url": {
            "type": "string",
            "format": "uri",
            "description": "Link to the source documentation",
            "examples": ["http://localhost:3000/docs/chapter-3#forward-kinematics"]
          },
          "similarity": {
            "type": "number",
            "description": "Cosine similarity score (0-1, higher = more relevant)",
            "minimum": 0,
            "maximum": 1,
            "examples": [0.92, 0.87, 0.75]
          }
        }
      }
    },
    "confidence": {
      "type": "number",
      "description": "Overall confidence in the answer (0-1). <0.8 means uncertain - 'I'm not entirely certain...' should be displayed",
      "minimum": 0,
      "maximum": 1,
      "examples": [0.87, 0.92, 0.65]
    },
    "metadata": {
      "type": "object",
      "description": "Operational metrics and search boosting information",
      "required": ["searchLatencyMs", "generationLatencyMs", "totalLatencyMs"],
      "properties": {
        "searchLatencyMs": {
          "type": "integer",
          "description": "Time spent on vector search (milliseconds)",
          "minimum": 0,
          "examples": [145, 200, 350]
        },
        "generationLatencyMs": {
          "type": "integer",
          "description": "Time spent on LLM generation (milliseconds)",
          "minimum": 0,
          "examples": [1230, 1500, 2000]
        },
        "totalLatencyMs": {
          "type": "integer",
          "description": "Total end-to-end latency (milliseconds)",
          "minimum": 0,
          "examples": [1375, 1700, 2350]
        },
        "chunksRetrieved": {
          "type": "integer",
          "description": "Number of chunks retrieved from vector database before boosting",
          "minimum": 0,
          "examples": [5, 10, 20]
        },
        "chunksUsed": {
          "type": "integer",
          "description": "Number of chunks passed to LLM context window",
          "minimum": 0,
          "examples": [3, 5, 8]
        },
        "model": {
          "type": "string",
          "description": "LLM model used for generation",
          "examples": ["gemini-1.5-flash", "gpt-4o-mini"]
        },
        "tokensUsed": {
          "type": "integer",
          "description": "Approximate total tokens used in generation (optional)",
          "minimum": 0,
          "examples": [450, 500]
        },
        "selectedTextBoosted": {
          "type": "boolean",
          "description": "Whether selected_text parameter was provided and used for search boosting",
          "examples": [true, false]
        },
        "selectedTextTerms": {
          "type": "array",
          "description": "Terms extracted from selected_text that were used for boosting (optional, only if boosted=true)",
          "items": {
            "type": "string"
          },
          "examples": [["forward", "kinematics"], ["inverse", "kinematics"]]
        },
        "boostFactor": {
          "type": "number",
          "description": "Multiplier applied to cosine similarity scores when selected_text matched (optional, only if boosted=true)",
          "minimum": 1.0,
          "maximum": 5.0,
          "examples": [1.5, 2.0, 1.3]
        },
        "termFrequency": {
          "type": "object",
          "description": "Term frequency scores for selected_text terms in top results (optional, for debugging)",
          "additionalProperties": {
            "type": "number",
            "minimum": 0,
            "maximum": 1
          },
          "examples": [{"forward": 0.8, "kinematics": 0.9}, {"inverse": 0.7, "kinematics": 0.85}]
        }
      }
    },
    "error": {
      "type": "object",
      "description": "Error information (only present if request failed)",
      "required": ["code", "message"],
      "properties": {
        "code": {
          "type": "string",
          "description": "Error code for categorization",
          "examples": ["BAD_REQUEST", "BACKEND_UNAVAILABLE", "INVALID_SELECTED_TEXT"]
        },
        "message": {
          "type": "string",
          "description": "User-friendly error message",
          "examples": ["Could not find relevant information in the textbook.", "Selected text parameter exceeds maximum length."]
        }
      }
    }
  },
  "additionalProperties": false,
  "examples": [
    {
      "answer": "Forward kinematics is the process of determining the position and orientation of the end-effector given the joint angles. See Chapter 3, Section 3.2 for detailed mathematical derivations.",
      "sources": [
        {
          "id": "chunk-3-2-1",
          "title": "Chapter 3, Section 3.2 - Forward Kinematics",
          "snippet": "Forward kinematics is the process of determining the spatial position and orientation of the end-effector (also called tool or hand) of a robotic manipulator...",
          "url": "http://localhost:3000/docs/chapter-3#forward-kinematics",
          "similarity": 0.95
        }
      ],
      "confidence": 0.92,
      "metadata": {
        "searchLatencyMs": 145,
        "generationLatencyMs": 1230,
        "totalLatencyMs": 1375,
        "chunksRetrieved": 5,
        "chunksUsed": 3,
        "model": "gemini-1.5-flash",
        "tokensUsed": 450,
        "selectedTextBoosted": true,
        "selectedTextTerms": ["forward", "kinematics"],
        "boostFactor": 1.5,
        "termFrequency": {"forward": 0.95, "kinematics": 0.98}
      }
    },
    {
      "answer": "Inverse kinematics is the process of finding joint angles that produce a desired end-effector position. See Chapter 4 for detailed explanations.",
      "sources": [
        {
          "id": "chunk-4-1-2",
          "title": "Chapter 4 - Inverse Kinematics",
          "snippet": "Inverse kinematics involves calculating the required joint angles...",
          "url": "http://localhost:3000/docs/chapter-4#inverse-kinematics",
          "similarity": 0.88
        }
      ],
      "confidence": 0.85,
      "metadata": {
        "searchLatencyMs": 160,
        "generationLatencyMs": 1100,
        "totalLatencyMs": 1260,
        "chunksRetrieved": 4,
        "chunksUsed": 2,
        "model": "gemini-1.5-flash",
        "selectedTextBoosted": false,
        "selectedTextTerms": null,
        "boostFactor": 1.0
      }
    }
  ]
}
