{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "RAG Chat Response",
  "description": "Response payload returned from RAG backend endpoint to ChatKit widget",
  "type": "object",
  "required": ["answer", "sources", "confidence", "metadata"],
  "properties": {
    "answer": {
      "type": "string",
      "description": "LLM-generated answer with citations",
      "minLength": 1,
      "examples": ["Forward kinematics is the process of determining... See Chapter 3, Section 3.2 for details."]
    },
    "sources": {
      "type": "array",
      "description": "Retrieved chunks with source attribution",
      "minItems": 0,
      "maxItems": 10,
      "items": {
        "type": "object",
        "required": ["id", "title", "snippet", "url", "similarity"],
        "properties": {
          "id": {
            "type": "string",
            "description": "Unique chunk ID from vector database",
            "examples": ["chunk-3-2-1", "robotics-ch3-sec2-para1"]
          },
          "title": {
            "type": "string",
            "description": "Chapter and section title",
            "examples": ["Chapter 3, Section 3.2 - Forward Kinematics"]
          },
          "snippet": {
            "type": "string",
            "description": "Relevant text excerpt (200-400 characters)",
            "minLength": 10,
            "maxLength": 500
          },
          "url": {
            "type": "string",
            "format": "uri",
            "description": "Link to the source documentation",
            "examples": ["http://localhost:3000/docs/chapter-3#forward-kinematics"]
          },
          "similarity": {
            "type": "number",
            "description": "Cosine similarity score (0-1)",
            "minimum": 0,
            "maximum": 1,
            "examples": [0.92, 0.87, 0.75]
          }
        }
      }
    },
    "confidence": {
      "type": "number",
      "description": "Overall confidence in the answer (0-1). <0.8 means 'uncertain' flag should be shown.",
      "minimum": 0,
      "maximum": 1,
      "examples": [0.87, 0.92, 0.65]
    },
    "metadata": {
      "type": "object",
      "description": "Operational metrics for the response",
      "required": ["searchLatencyMs", "generationLatencyMs", "totalLatencyMs"],
      "properties": {
        "searchLatencyMs": {
          "type": "integer",
          "description": "Time spent on vector search (milliseconds)",
          "minimum": 0,
          "examples": [145, 200, 350]
        },
        "generationLatencyMs": {
          "type": "integer",
          "description": "Time spent on LLM generation (milliseconds)",
          "minimum": 0,
          "examples": [1230, 1500, 2000]
        },
        "totalLatencyMs": {
          "type": "integer",
          "description": "Total request latency (milliseconds)",
          "minimum": 0,
          "examples": [1375, 1700, 2350]
        },
        "chunksRetrieved": {
          "type": "integer",
          "description": "Number of chunks retrieved from vector database",
          "minimum": 0,
          "examples": [5, 10, 20]
        },
        "chunksUsed": {
          "type": "integer",
          "description": "Number of chunks passed to LLM",
          "minimum": 0,
          "examples": [3, 5, 8]
        },
        "model": {
          "type": "string",
          "description": "LLM model used for generation",
          "examples": ["gemini-1.5-flash", "gpt-4o-mini"]
        },
        "tokensUsed": {
          "type": "integer",
          "description": "Approximate total tokens used (optional)",
          "minimum": 0,
          "examples": [450, 500]
        }
      }
    },
    "error": {
      "type": "object",
      "description": "Error information (only present if request failed)",
      "required": ["code", "message"],
      "properties": {
        "code": {
          "type": "string",
          "description": "Error code for categorization",
          "examples": ["BAD_REQUEST", "BACKEND_UNAVAILABLE", "INTERNAL_SERVER_ERROR"]
        },
        "message": {
          "type": "string",
          "description": "User-friendly error message",
          "examples": ["Could not find relevant information in the textbook.", "Service temporarily unavailable. Please try again later."]
        }
      }
    }
  },
  "additionalProperties": false,
  "examples": [
    {
      "answer": "Forward kinematics is the process of determining the position and orientation of the end-effector of a robotic arm given the joint angles. See Chapter 3, Section 3.2 for detailed mathematical derivations.",
      "sources": [
        {
          "id": "chunk-3-2-1",
          "title": "Chapter 3, Section 3.2 - Forward Kinematics",
          "snippet": "Forward kinematics is the process of determining the spatial position and orientation of the end-effector (also called tool or hand) of a robotic manipulator...",
          "url": "http://localhost:3000/docs/chapter-3-kinematics#forward-kinematics",
          "similarity": 0.92
        }
      ],
      "confidence": 0.87,
      "metadata": {
        "searchLatencyMs": 145,
        "generationLatencyMs": 1230,
        "totalLatencyMs": 1375,
        "chunksRetrieved": 5,
        "chunksUsed": 3,
        "model": "gemini-1.5-flash",
        "tokensUsed": 450
      }
    },
    {
      "answer": "I'm not entirely certain, but based on Chapter 2, the concept you're asking about relates to basic robotics principles.",
      "sources": [
        {
          "id": "chunk-2-1-3",
          "title": "Chapter 2 - Robotics Fundamentals",
          "snippet": "Basic robotics principles include...",
          "url": "http://localhost:3000/docs/chapter-2#fundamentals",
          "similarity": 0.65
        }
      ],
      "confidence": 0.62,
      "metadata": {
        "searchLatencyMs": 180,
        "generationLatencyMs": 980,
        "totalLatencyMs": 1160,
        "chunksRetrieved": 3,
        "chunksUsed": 1,
        "model": "gemini-1.5-flash"
      }
    }
  ]
}
